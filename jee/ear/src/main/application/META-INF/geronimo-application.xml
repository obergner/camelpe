<?xml version="1.0" encoding="UTF-8"?>
<application xmlns="http://geronimo.apache.org/xml/ns/j2ee/application-2.0"
	xmlns:sys="http://geronimo.apache.org/xml/ns/deployment-1.2" xmlns:sec="http://geronimo.apache.org/xml/ns/security-2.0"
	application-name="OrderPlacement">

	<sys:environment>
		<sys:moduleId>
			<sys:groupId>${geronimo.moduleId.groupId}</sys:groupId>
			<sys:artifactId>${geronimo.moduleId.artifactId}</sys:artifactId>
			<sys:version>${geronimo.moduleId.version}</sys:version>
			<sys:type>${geronimo.moduleId.type}</sys:type>
		</sys:moduleId>
		<sys:hidden-classes>
			<sys:filter>org.slf4j</sys:filter>
			<sys:filter>org.apache.log4j</sys:filter>
			<!-- sys:filter>org.apache.commons.logging</sys:filter -->
			<sys:filter>org.springframework</sys:filter>
			<sys:filter>org.aspectj</sys:filter>
			<sys:filter>org.aopalliance</sys:filter>
			<sys:filter>org.hibernate</sys:filter>
			<sys:filter>antlr</sys:filter>
			<sys:filter>javassist</sys:filter>
		</sys:hidden-classes>
	</sys:environment>

	<module>
		<connector>tranql-connector-postgresql-xa-1.1.rar</connector>
		<connector xmlns="http://geronimo.apache.org/xml/ns/j2ee/connector-1.2">
			<sys:environment>
				<sys:moduleId>
					<sys:groupId>com.acme.orderplacement.dbpool</sys:groupId>
					<sys:artifactId>OrderPlacementDS</sys:artifactId>
					<sys:version>${project.version}</sys:version>
					<sys:type>rar</sys:type>
				</sys:moduleId>
				<sys:dependencies>
					<sys:dependency>
						<sys:groupId>org.postgresql</sys:groupId>
						<sys:artifactId>jdbc3</sys:artifactId>
						<sys:version>8.3.604</sys:version>
						<sys:type>jar</sys:type>
					</sys:dependency>
				</sys:dependencies>
			</sys:environment>
			<resourceadapter>
				<outbound-resourceadapter>
					<connection-definition>
						<connectionfactory-interface>javax.sql.DataSource</connectionfactory-interface>
						<connectiondefinition-instance>
							<name>jdbc/com/acme/OrderPlacementDS</name>
							<config-property-setting name="Password">postgres</config-property-setting>
							<config-property-setting name="DatabaseName">orderplacement</config-property-setting>
							<config-property-setting name="PrepareThreshold">1</config-property-setting>
							<config-property-setting name="UserName">postgres</config-property-setting>
							<connectionmanager>
								<xa-transaction>
									<transaction-caching />
								</xa-transaction>
								<single-pool>
									<max-size>10</max-size>
									<min-size>0</min-size>
									<blocking-timeout-milliseconds>5000</blocking-timeout-milliseconds>
									<idle-timeout-minutes>15</idle-timeout-minutes>
									<match-one />
								</single-pool>
							</connectionmanager>
						</connectiondefinition-instance>
					</connection-definition>
				</outbound-resourceadapter>
			</resourceadapter>
		</connector>
	</module>

	<module>
		<ejb>orderplacement.jee.ejb-${project.version}.jar</ejb>
		<openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2"
			xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2">

			<sys:environment>
				<sys:moduleId>
					<sys:groupId>com.acme.orderplacement.jee</sys:groupId>
					<sys:artifactId>orderplacement.jee.ejb</sys:artifactId>
					<sys:version>${project.version}</sys:version>
					<sys:type>jar</sys:type>
				</sys:moduleId>
			</sys:environment>

			<enterprise-beans>
				<session>
					<ejb-name>ItemStorageServiceEJB</ejb-name>
					<naming:resource-ref>
						<naming:ref-name>jdbc/OrderPlacementDS</naming:ref-name>
						<naming:resource-link>jdbc/com/acme/OrderPlacementDS</naming:resource-link>
					</naming:resource-ref>
				</session>
			</enterprise-beans>

		</openejb-jar>
	</module>

	<module>
		<ejb>orderplacement.jee.integrationmdb-${project.version}.jar</ejb>
		<openejb-jar xmlns="http://openejb.apache.org/xml/ns/openejb-jar-2.2"
			xmlns:naming="http://geronimo.apache.org/xml/ns/naming-1.2">

			<sys:environment>
				<sys:moduleId>
					<sys:groupId>com.acme.orderplacement.jee</sys:groupId>
					<sys:artifactId>orderplacement.jee.integrationmdb</sys:artifactId>
					<sys:version>${project.version}</sys:version>
					<sys:type>jar</sys:type>
				</sys:moduleId>
			</sys:environment>

			<enterprise-beans>
				<message-driven>
					<ejb-name>ItemCreatedEventChannelAdapterMDB
					</ejb-name>
					<naming:ejb-local-ref>
						<naming:ref-name>ejb/com/acme/orderplacment/item/ItemStorageService</naming:ref-name>
						<naming:ejb-link>ItemStorageServiceEJB</naming:ejb-link>
					</naming:ejb-local-ref>
					<naming:resource-adapter>
						<naming:resource-link>jms/com/acme/OrderplacementJMSResources</naming:resource-link>
					</naming:resource-adapter>
					<naming:resource-ref>
						<naming:ref-name>jms/com/acme/ConnectionFactory</naming:ref-name>
						<naming:resource-link>jms/com/acme/ConnectionFactory</naming:resource-link>
					</naming:resource-ref>
					<naming:resource-env-ref>
						<naming:ref-name>jms/queue/com/acme/ItemCreatedEventsErrorQueue</naming:ref-name>
						<naming:admin-object-link>jms/queue/com/acme/ItemCreatedEventsErrorQueue</naming:admin-object-link>
					</naming:resource-env-ref>
				</message-driven>
			</enterprise-beans>

		</openejb-jar>
	</module>

	<module>
		<web>orderplacement.jee.ws-1.0-SNAPSHOT.war</web>
		<web-app xmlns="http://geronimo.apache.org/xml/ns/j2ee/web-2.0.1">
			<sys:environment>
				<sys:moduleId>
					<sys:groupId>com.acme.orderplacement.jee</sys:groupId>
					<sys:artifactId>orderplacement.jee.ws</sys:artifactId>
					<sys:version>${project.version}</sys:version>
					<sys:type>war</sys:type>
				</sys:moduleId>
			</sys:environment>
			<context-root>/orderplacement</context-root>
		</web-app>
	</module>

	<ext-module>
		<connector>jms/com/acme/OrderplacementJMSResources</connector>
		<external-path>
			<sys:groupId>org.apache.geronimo.modules</sys:groupId>
			<sys:artifactId>geronimo-activemq-ra</sys:artifactId>
			<sys:version>2.2</sys:version>
		</external-path>
		<connector xmlns="http://geronimo.apache.org/xml/ns/j2ee/connector-1.2">
			<sys:environment>
				<sys:moduleId>
					<sys:groupId>com.acme.orderplacement.jee</sys:groupId>
					<sys:artifactId>jmsResources</sys:artifactId>
					<sys:version>${project.version}</sys:version>
					<sys:type>rar</sys:type>
				</sys:moduleId>
			</sys:environment>
			<resourceadapter>
				<!--how to connect to the JMS Server-->
				<resourceadapter-instance>
					<resourceadapter-name>jms/com/acme/OrderplacementJMSResources</resourceadapter-name>
					<config-property-setting name="ServerUrl">tcp://localhost:61616</config-property-setting>
					<config-property-setting name="UserName">not needed</config-property-setting>
					<config-property-setting name="Password">not needed</config-property-setting>
					<workmanager xmlns="http://geronimo.apache.org/xml/ns/naming-1.2">
						<gbean-link>DefaultWorkManager</gbean-link>
					</workmanager>
				</resourceadapter-instance>

				<!--defines a ConnectionFactory-->
				<outbound-resourceadapter>
					<connection-definition>
						<connectionfactory-interface>javax.jms.ConnectionFactory</connectionfactory-interface>
						<connectiondefinition-instance>
							<name>jms/com/acme/ConnectionFactory</name>
							<implemented-interface>javax.jms.TopicConnectionFactory</implemented-interface>
							<implemented-interface>javax.jms.QueueConnectionFactory</implemented-interface>
							<connectionmanager>
								<xa-transaction>
									<transaction-caching />
								</xa-transaction>
								<single-pool>
									<max-size>10</max-size>
									<min-size>0</min-size>
									<blocking-timeout-milliseconds>5000</blocking-timeout-milliseconds>
									<idle-timeout-minutes>0</idle-timeout-minutes>
									<match-one />
								</single-pool>
							</connectionmanager>
						</connectiondefinition-instance>
					</connection-definition>
				</outbound-resourceadapter>
			</resourceadapter>

			<adminobject>
				<adminobject-interface>javax.jms.Topic</adminobject-interface>
				<adminobject-class>org.activemq.message.ActiveMQTopic</adminobject-class>
				<adminobject-instance>
					<message-destination-name>jms/topic/com/acme/ItemCreatedEventsTopic</message-destination-name>
					<config-property-setting name="PhysicalName">jms/topic/com/acme/ItemCreatedEventsTopic</config-property-setting>
				</adminobject-instance>
			</adminobject>

			<adminobject>
				<adminobject-interface>javax.jms.Queue</adminobject-interface>
				<adminobject-class>org.activemq.message.ActiveMQQueue</adminobject-class>
				<adminobject-instance>
					<message-destination-name>jms/queue/com/acme/ItemCreatedEventsErrorQueue</message-destination-name>
					<config-property-setting name="PhysicalName">jms/queue/com/acme/ItemCreatedEventsErrorQueue</config-property-setting>
				</adminobject-instance>
			</adminobject>
		</connector>
	</ext-module>

	<sec:security use-context-handler="false"
		doas-current-caller="true" default-role="admin1">
		<sec:role-mappings>
			<sec:role role-name="admin-role">
				<sec:description>ability to do everything</sec:description>
			</sec:role>
			<sec:role role-name="user-role">
				<sec:description>limited access</sec:description>
			</sec:role>
		</sec:role-mappings>
	</sec:security>

	<sys:gbean name="SharedApplicationContext"
		class="com.acme.orderplacement.jee.geronimo.spring.ApplicationContextGBean">
		<sys:reference name="globalJndiContext">
			<sys:name>GlobalContext</sys:name>
		</sys:reference>
		<sys:attribute name="applicationContextResourceLocation"
			type="java.lang.String">META-INF/spring/app.sharedApplicationContext.scontext</sys:attribute>
		<sys:attribute name="jndiName" type="java.lang.String">java:spring/com/acme/orderplacement/app/SharedApplicationContext</sys:attribute>
	</sys:gbean>

</application>

